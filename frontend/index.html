<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refined Tabbed Document Workspace</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #333333;
        }
        #tab-container {
            display: flex;
            background-color: #f0f0f0;
            padding: 10px 10px 0 10px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #e0e0e0;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        .tab.active {
            background-color: #ffffff;
        }
        #workspace-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 50px);
            overflow: hidden;
        }
        .workspace {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
        }
        .workspace.active {
            display: block;
        }
        .document, .note {
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .document {
            min-width: 200px;
            min-height: 200px;
        }
        .note {
            width: 200px;
            height: 150px;
        }
        .header {
            padding: 8px 12px;
            background-color: #f0f0f0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
        }
        .content {
            padding: 12px;
            flex-grow: 1;
            overflow: auto;
        }
        .controls {
            display: flex;
            gap: 8px;
        }
        .control {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .control:hover {
            background-color: #e0e0e0;
        }
        .close { color: #f44336; }
        .add-note { color: #2196f3; }
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #bdbdbd;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
        }
        #drop-zone {
            position: fixed;
            top: 60px;
            left: 20px;
            padding: 20px;
            border: 2px dashed #9e9e9e;
            border-radius: 8px;
            font-size: 16px;
            color: #616161;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        #drop-zone.drag-over {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .connection-line {
            position: absolute;
            pointer-events: none;
            z-index: 0;
        }
        .connection-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #2196f3;
            border-radius: 50%;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="tab-container">
        <div class="tab active" onclick="switchWorkspace(0)">Workspace 1</div>
        <div class="tab" onclick="switchWorkspace(1)">Workspace 2</div>
        <div class="tab" onclick="switchWorkspace(2)">Workspace 3</div>
    </div>
    <div id="workspace-container">
        <div class="workspace active" id="workspace-0"></div>
        <div class="workspace" id="workspace-1"></div>
        <div class="workspace" id="workspace-2"></div>
    </div>
    <div id="drop-zone">Drag & Drop Files Here</div>

    <script>
        let draggedElement = null;
        let resizedElement = null;
        let offset = { x: 0, y: 0 };
        let zIndex = 1;
        let currentWorkspace = 0;

        const workspaces = document.querySelectorAll('.workspace');
        const dropZone = document.getElementById('drop-zone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', handleFileDrop);

        function switchWorkspace(index) {
            document.querySelector('.tab.active').classList.remove('active');
            document.querySelectorAll('.tab')[index].classList.add('active');
            document.querySelector('.workspace.active').classList.remove('active');
            workspaces[index].classList.add('active');
            currentWorkspace = index;
        }

        function handleFileDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            for (let file of files) {
                createDocumentElement(file);
            }
        }

        function createDocumentElement(file) {
            const doc = document.createElement('div');
            doc.className = 'document';
            doc.innerHTML = `
                <div class="header">
                    <span>${file.name}</span>
                    <div class="controls">
                        <span class="control add-note" onclick="addNoteToDocument(this)">+Note</span>
                        <span class="control close" onclick="removeDocument(this)">×</span>
                    </div>
                </div>
                <div class="content"></div>
                <div class="resize-handle"></div>
            `;

            const content = doc.querySelector('.content');
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '100%';
                content.appendChild(img);
            } else if (file.type === 'application/pdf') {
                const obj = document.createElement('object');
                obj.data = URL.createObjectURL(file);
                obj.type = 'application/pdf';
                obj.width = '100%';
                obj.height = '100%';
                content.appendChild(obj);
            } else {
                content.textContent = `File type not supported: ${file.type}`;
            }

            doc.style.width = '300px';
            doc.style.height = '300px';
            placeElement(doc);

            const header = doc.querySelector('.header');
            header.addEventListener('mousedown', startDragging);

            const resizeHandle = doc.querySelector('.resize-handle');
            resizeHandle.addEventListener('mousedown', startResizing);

            doc.addEventListener('mousedown', () => bringToFront(doc));
        }

        function createNoteElement(docElement) {
            const note = document.createElement('div');
            note.className = 'note';
            note.innerHTML = `
                <div class="header">
                    <span>Note</span>
                    <div class="controls">
                        <span class="control close" onclick="removeNote(this)">×</span>
                    </div>
                </div>
                <div class="content" contenteditable="true">Enter your note here...</div>
                <div class="resize-handle"></div>
            `;

            const header = note.querySelector('.header');
            header.addEventListener('mousedown', startDragging);

            const resizeHandle = note.querySelector('.resize-handle');
            resizeHandle.addEventListener('mousedown', startResizing);

            note.addEventListener('mousedown', () => bringToFront(note));

            note.docElement = docElement;
            return note;
        }

        function addNoteToDocument(button) {
            const doc = button.closest('.document');
            const note = createNoteElement(doc);
            note.style.left = (parseInt(doc.style.left) + 20) + 'px';
            note.style.top = (parseInt(doc.style.top) + 20) + 'px';
            workspaces[currentWorkspace].appendChild(note);
            bringToFront(note);
            createConnection(doc, note);
        }

        function createConnection(doc, note) {
            const connection = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            connection.setAttribute('class', 'connection-line');
            connection.style.overflow = 'visible';
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', '#a0a0a0');
            path.setAttribute('stroke-width', '2');
            connection.appendChild(path);

            const startDot = document.createElement('div');
            startDot.className = 'connection-dot';
            const endDot = document.createElement('div');
            endDot.className = 'connection-dot';

            workspaces[currentWorkspace].appendChild(connection);
            workspaces[currentWorkspace].appendChild(startDot);
            workspaces[currentWorkspace].appendChild(endDot);

            note.connection = { svg: connection, path: path, startDot: startDot, endDot: endDot };
            updateConnection(doc, note);
        }

        function updateConnection(doc, note) {
            const { svg, path, startDot, endDot } = note.connection;
            const docRect = doc.getBoundingClientRect();
            const noteRect = note.getBoundingClientRect();

            const docCenter = {
                x: docRect.left + docRect.width / 2,
                y: docRect.top + docRect.height / 2
            };

            const noteCenter = {
                x: noteRect.left + noteRect.width / 2,
                y: noteRect.top + noteRect.height / 2
            };

            const angle = Math.atan2(noteCenter.y - docCenter.y, noteCenter.x - docCenter.x);
            const docX = docCenter.x + Math.cos(angle) * (docRect.width / 2);
            const docY = docCenter.y + Math.sin(angle) * (docRect.height / 2);
            const noteX = noteCenter.x - Math.cos(angle) * (noteRect.width / 2);
            const noteY = noteCenter.y - Math.sin(angle) * (noteRect.height / 2);

            const midX = (docX + noteX) / 2;
            const midY = (docY + noteY) / 2;
            const controlX = midX + (noteY - docY) * 0.25;
            const controlY = midY - (noteX - docX) * 0.25;

            const pathD = `M${docX},${docY} Q${controlX},${controlY} ${noteX},${noteY}`;
            path.setAttribute('d', pathD);

            svg.style.left = '0';
            svg.style.top = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';

            startDot.style.left = `${docX - 3}px`;
            startDot.style.top = `${docY - 3}px`;

            endDot.style.left = `${noteX - 3}px`;
            endDot.style.top = `${noteY - 3}px`;
        }

        function placeElement(element) {
            element.style.left = Math.random() * (workspaces[currentWorkspace].clientWidth - 300) + 'px';
            element.style.top = Math.random() * (workspaces[currentWorkspace].clientHeight - 300) + 'px';
            workspaces[currentWorkspace].appendChild(element);
            bringToFront(element);
        }

        function startDragging(e) {
            if (e.target.classList.contains('control')) return;
            draggedElement = this.closest('.document') || this.closest('.note');
            bringToFront(draggedElement);
            offset.x = e.clientX - draggedElement.offsetLeft;
            offset.y = e.clientY - draggedElement.offsetTop;
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDragging);
        }

        function drag(e) {
            if (!draggedElement) return;
            const newLeft = e.clientX - offset.x;
            const newTop = e.clientY - offset.y;
            draggedElement.style.left = `${Math.max(0, newLeft)}px`;
            draggedElement.style.top = `${Math.max(0, newTop)}px`;

            if (draggedElement.classList.contains('note')) {
                updateConnection(draggedElement.docElement, draggedElement);
            } else if (draggedElement.classList.contains('document')) {
                const notes = Array.from(workspaces[currentWorkspace].querySelectorAll('.note')).filter(note => note.docElement === draggedElement);
                notes.forEach(note => updateConnection(draggedElement, note));
            }
        }

        function stopDragging() {
            draggedElement = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDragging);
        }

        function startResizing(e) {
            e.stopPropagation();
            resizedElement = this.closest('.document') || this.closest('.note');
            bringToFront(resizedElement);
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResizing);
        }

        function resize(e) {
            if (!resizedElement) return;
            const newWidth = Math.max(200, e.clientX - resizedElement.offsetLeft);
            const newHeight = Math.max(200, e.clientY - resizedElement.offsetTop);
            resizedElement.style.width = newWidth + 'px';
            resizedElement.style.height = newHeight + 'px';

            if (resizedElement.classList.contains('document')) {
                const notes = Array.from(workspaces[currentWorkspace].querySelectorAll('.note')).filter(note => note.docElement === resizedElement);
                notes.forEach(note => updateConnection(resizedElement, note));
            } else if (resizedElement.classList.contains('note')) {
                updateConnection(resizedElement.docElement, resizedElement);
            }
        }

        function stopResizing() {
            resizedElement = null;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResizing);
        }

        function bringToFront(element) {
            element.style.zIndex = ++zIndex;
        }

        function removeDocument(closeButton) {
            const doc = closeButton.closest('.document');
            const notes = Array.from(workspaces[currentWorkspace].querySelectorAll('.note')).filter(note => note.docElement === doc);
            notes.forEach(removeNote);
            doc.remove();
        }

        function removeNote(closeButton) {
            const note = closeButton.closest ? closeButton.closest('.note') : closeButton;
            if (note.connection) {
                note.connection.svg.remove();
                note.connection.startDot.remove();
                note.connection.endDot.remove();
            }
            note.remove();
        }
    </script>
</body>
</html>